library(dplyr)
library(readxl)
library(writexl)
library(lubridate)
library(glue)
library(tools)
library(janitor)
library(odbc)
library(dbplyr)
library(tidyverse)
library(DBI)

## Leemos el r-10 del dia de hoy ##

ruta <- "//coomeva.nal/DFSCoomeva/Cartera_Coomeva/CARTERA/13. Archivos de gestión/Reporte 10 nuevo"
archivos_con_fechas <- file.info(list.files(path = ruta, full.names = TRUE))
archivos_excel <- archivos_con_fechas[grep("\\.xlsx$", rownames(archivos_con_fechas), ignore.case = TRUE), ]
ultimo_archivo <- rownames(archivos_excel)[which.max(archivos_excel$mtime)]
data <- read_excel(ultimo_archivo)

## Analizar campaña CR MORA 0 ##

cr_mora0 <- data %>% filter(`TIPO CLIENTE` %in% c("Mixto (Asociado/Cliente)", "Solo Asociado"),
                            SUBCAMPAÑA == "MORA 0 CR",
                            `TIPO CARTERA` == "M",
                            `EDAD CARTERA HOY` > 0)



cr_mora0 <- cr_mora0 %>% select(`CEDULA ASOCIADO`,`NOMBRE ASOCIADO`,`EDAD CARTERA INICIAL`,`EDAD CARTERA HOY`,`DESCRIPCIÓN DEL ESTADO MULTIACTIVA HOY`,SUBCAMPAÑA, `VALOR VENCIDO HOY`)

## Desagregar x Empresas ##

Connecion_SQL <- dbConnect( 
  odbc(),
  Driver = "Oracle in instantclient_21_3",
  DBQ = "bdcdpora23.intracoomeva.com.co:1575/CDPORA23", 
  SVC = "GRC", 
  encoding = "ISO-8859-1", 
  UID = "jjvt9593", 
  PWD = "KyCo_090625*")


## Coomeva ## 

Coomeva_hoy <- dbGetQuery(Connecion_SQL,glue_sql("SELECT ASO_IDENTIFICACION,
                                                  MAX(CASE WHEN FACT_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE FACT_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA_HOY,
                                                  SUM(FAC.FACT_VALOR_CUOTA_MES) VALOR_CUOTA_MES_HOY,
                                                  SUM(FAC.FACT_VALOR_VENCIDO) VALOR_VENCIDO_HOY,
                                                  SUM(FAC.FACT_VALOR_CUOTA_MES + FAC.FACT_VALOR_VENCIDO) TOTAL_FACTURADO
                                                    FROM GRC.STG_GCC_FACTURACION FAC
                                                    LEFT OUTER JOIN GRC.GCC_CONCEPTO CON
                                                    ON FAC.CON_CODIGO = CON.CON_CODIGO
                                                    LEFT OUTER JOIN GRC.GCC_AGRUPACION EMP
                                                    ON CON.AGR_CODIGO = EMP.AGR_CODIGO
                                                      WHERE emp.age_codigo = 3
                                                    GROUP BY (FAC.ASO_IDENTIFICACION)"))



## MP ##


MP_hoy <- dbGetQuery(Connecion_SQL,glue_sql(
  "SELECT ASO_IDENTIFICACION,
MAX(CASE WHEN FACT_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE FACT_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES) VALOR_CUOTA_MES_HOY,
SUM(FAC.FACT_VALOR_VENCIDO) VALOR_VENCIDO_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES + FAC.FACT_VALOR_VENCIDO) TOTAL_FACTURADO
FROM GRC.STG_GCC_FACTURACION FAC
LEFT OUTER JOIN GRC.GCC_CONCEPTO CON
ON FAC.CON_CODIGO = CON.CON_CODIGO
LEFT OUTER JOIN GRC.GCC_AGRUPACION EMP
ON CON.AGR_CODIGO = EMP.AGR_CODIGO
WHERE emp.age_codigo = 2 
AND FAC.CON_CODIGO NOT IN ('CEMR',
'01CEAB',
'01CEAD',
'01CEAG',
'01CEAM',
'01CEAP',
'01CEAS',
'01CEAT',
'01CEA9',
'01CEB',
'01CEB1',
'01CECA',
'01CECE',
'01CEC1',
'01CEEF',
'01CEE1',
'01CEE2',
'01CEFE',
'01CEFG',
'01CEFI',
'01CEFO',
'01CEGF',
'01CEIN',
'01CEM',
'01CEMA',
'01CEMB',
'01CEMC',
'01CEME',
'01CEMH',
'01CEMJ',
'01CEMO',
'01CEMS',
'01CEMX',
'01CEMZ',
'01CEM1',
'01CEM3',
'01CEM4',
'01CEM7',
'01CEM8',
'01CEOC',
'01CEPD',
'01CEPM',
'01CEPO',
'01CEPR',
'01CEPS',
'01CEP2',
'01CERP',
'01CETE',
'01CET9',
'01CEUS',
'01CEX0',
'01CEX1',
'01CEX3',
'01CE19',
'01CE2P',
'01CE23',
'01CPEM',
'01EVEM',
'04CEAB',
'04CEAD',
'04CEAG',
'04CEAM',
'04CEAP',
'04CEAS',
'04CEAT',
'04CEA9',
'04CEB',
'04CEB1',
'04CECA',
'04CECE',
'04CEC1',
'04CEEF',
'04CEE1',
'04CEE2',
'04CEFE',
'04CEFG',
'04CEFI',
'04CEFO',
'04CEGF',
'04CEIN',
'04CEM',
'04CEMA',
'04CEMB',
'04CEMC',
'04CEME',
'04CEMH',
'04CEMJ',
'04CEMO',
'04CEMS',
'04CEMX',
'04CEMZ',
'04CEM1',
'04CEM3',
'04CEM4',
'04CEM7',
'04CEM8',
'04CEOC',
'04CEPD',
'04CEPM',
'04CEPO',
'04CEPR',
'04CEPS',
'04CEP2',
'04CERP',
'04CETE',
'04CET9',
'04CEUS',
'04CEX0',
'04CEX1',
'04CEX3',
'04CE19',
'04CE2P',
'04CE23',
'04CPEM',
'04EVEM',
'07CEM',
'07CEMC',
'07CEMO',
'07CEMS',
'07CEMZ',
'07CEM1',
'07CEM3',
'07CEM4',
'07CEM7',
'07CEM8',
'08CEM',
'08CEMC',
'08CEMJ',
'08CEMO',
'08CEMS',
'08CEMZ',
'08CEM1',
'08CEM3',
'08CEM4',
'08CEM7',
'08CEM8',
'09CEAG',
'09CEAP',
'09CEAS',
'09CEAT',
'09CEFE',
'09CEFG',
'09CEFO',
'09CEGF',
'09CEM',
'09CEMC',
'09CEMH',
'09CEMO',
'09CEMZ',
'09CEM1',
'09CEM3',
'09CEM4',
'09CEM7',
'09CEM8',
'09CEPD',
'09CEPM',
'09CEPO',
'09CEPR',
'09CEPS',
'09CEP2',
'09CERP',
'09CEX3',
'09CE2P',
'01CEMQ',
'04CEMQ',
'01CE50',
'04CE50',
'01PACE',
'04PACE',
'01TACE',
'04TACE',
'01CUE3',
'04CUE3',
'01CUE6',
'04CUE6',
'01CUE9',
'04CUE9',
'01CU12',
'04CU12',
'01CU23',
'04CU23',
'01CU26',
'04CU26',
'01CU29',
'04CU29',
'01CU22',
'04CU22',
'01CTL3',
'04CTL3',
'01CTL6',
'04CTL6',
'01CTL9',
'04CTL9',
'01CT12',
'04CT12',
'01CT23',
'04CT23',
'01CT26',
'04CT26',
'01CT29',
'04CT29',
'01CT22',
'04CT22',
'01FULL',
'04FULL')
GROUP BY (FAC.ASO_IDENTIFICACION);"))


## CEM HOY ##

CEM_hoy <- dbGetQuery(Connecion_SQL,glue_sql(
  "SELECT ASO_IDENTIFICACION,
MAX(CASE WHEN FACT_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE FACT_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES) VALOR_CUOTA_MES_HOY,
SUM(FAC.FACT_VALOR_VENCIDO) VALOR_VENCIDO_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES + FAC.FACT_VALOR_VENCIDO) TOTAL_FACTURADO
FROM GRC.STG_GCC_FACTURACION FAC
LEFT OUTER JOIN GRC.GCC_CONCEPTO CON
ON FAC.CON_CODIGO = CON.CON_CODIGO
LEFT OUTER JOIN GRC.GCC_AGRUPACION EMP
ON CON.AGR_CODIGO = EMP.AGR_CODIGO
WHERE emp.age_codigo = 2 
AND FAC.CON_CODIGO IN ('CEMR',
'01CEAB',
'01CEAD',
'01CEAG',
'01CEAM',
'01CEAP',
'01CEAS',
'01CEAT',
'01CEA9',
'01CEB',
'01CEB1',
'01CECA',
'01CECE',
'01CEC1',
'01CEEF',
'01CEE1',
'01CEE2',
'01CEFE',
'01CEFG',
'01CEFI',
'01CEFO',
'01CEGF',
'01CEIN',
'01CEM',
'01CEMA',
'01CEMB',
'01CEMC',
'01CEME',
'01CEMH',
'01CEMJ',
'01CEMO',
'01CEMS',
'01CEMX',
'01CEMZ',
'01CEM1',
'01CEM3',
'01CEM4',
'01CEM7',
'01CEM8',
'01CEOC',
'01CEPD',
'01CEPM',
'01CEPO',
'01CEPR',
'01CEPS',
'01CEP2',
'01CERP',
'01CETE',
'01CET9',
'01CEUS',
'01CEX0',
'01CEX1',
'01CEX3',
'01CE19',
'01CE2P',
'01CE23',
'01CPEM',
'01EVEM',
'04CEAB',
'04CEAD',
'04CEAG',
'04CEAM',
'04CEAP',
'04CEAS',
'04CEAT',
'04CEA9',
'04CEB',
'04CEB1',
'04CECA',
'04CECE',
'04CEC1',
'04CEEF',
'04CEE1',
'04CEE2',
'04CEFE',
'04CEFG',
'04CEFI',
'04CEFO',
'04CEGF',
'04CEIN',
'04CEM',
'04CEMA',
'04CEMB',
'04CEMC',
'04CEME',
'04CEMH',
'04CEMJ',
'04CEMO',
'04CEMS',
'04CEMX',
'04CEMZ',
'04CEM1',
'04CEM3',
'04CEM4',
'04CEM7',
'04CEM8',
'04CEOC',
'04CEPD',
'04CEPM',
'04CEPO',
'04CEPR',
'04CEPS',
'04CEP2',
'04CERP',
'04CETE',
'04CET9',
'04CEUS',
'04CEX0',
'04CEX1',
'04CEX3',
'04CE19',
'04CE2P',
'04CE23',
'04CPEM',
'04EVEM',
'07CEM',
'07CEMC',
'07CEMO',
'07CEMS',
'07CEMZ',
'07CEM1',
'07CEM3',
'07CEM4',
'07CEM7',
'07CEM8',
'08CEM',
'08CEMC',
'08CEMJ',
'08CEMO',
'08CEMS',
'08CEMZ',
'08CEM1',
'08CEM3',
'08CEM4',
'08CEM7',
'08CEM8',
'09CEAG',
'09CEAP',
'09CEAS',
'09CEAT',
'09CEFE',
'09CEFG',
'09CEFO',
'09CEGF',
'09CEM',
'09CEMC',
'09CEMH',
'09CEMO',
'09CEMZ',
'09CEM1',
'09CEM3',
'09CEM4',
'09CEM7',
'09CEM8',
'09CEPD',
'09CEPM',
'09CEPO',
'09CEPR',
'09CEPS',
'09CEP2',
'09CERP',
'09CEX3',
'09CE2P',
'01CEMQ',
'04CEMQ',
'01CE50',
'04CE50',
'01PACE',
'04PACE',
'01TACE',
'04TACE',
'01CUE3',
'04CUE3',
'01CUE6',
'04CUE6',
'01CUE9',
'04CUE9',
'01CU12',
'04CU12',
'01CU23',
'04CU23',
'01CU26',
'04CU26',
'01CU29',
'04CU29',
'01CU22',
'04CU22',
'01CTL3',
'04CTL3',
'01CTL6',
'04CTL6',
'01CTL9',
'04CTL9',
'01CT12',
'04CT12',
'01CT23',
'04CT23',
'01CT26',
'04CT26',
'01CT29',
'04CT29',
'01CT22',
'04CT22',
'01FULL',
'04FULL')
GROUP BY (FAC.ASO_IDENTIFICACION);"))



## Realizamos cruce de valores ##


## Coomeva ##

cr_mora0 <- cr_mora0 %>% left_join(Coomeva_hoy %>% select(ASO_IDENTIFICACION,EDAD_CARTERA_HOY,VALOR_VENCIDO_HOY,VALOR_CUOTA_MES_HOY), by = c("CEDULA ASOCIADO" = "ASO_IDENTIFICACION"))

cr_mora0 <- cr_mora0 %>% rename(Edad_Hoy_Coomeva = EDAD_CARTERA_HOY,
                                Valor_Vencido_Coomeva = VALOR_VENCIDO_HOY,
                                Valor_Cuota_Mes_Coomeva = VALOR_CUOTA_MES_HOY)


## MP ##

cr_mora0 <- cr_mora0 %>% left_join(MP_hoy %>% select(ASO_IDENTIFICACION,EDAD_CARTERA_HOY,VALOR_VENCIDO_HOY,VALOR_CUOTA_MES_HOY), by = c("CEDULA ASOCIADO" = "ASO_IDENTIFICACION"))

cr_mora0 <- cr_mora0 %>% rename(Edad_Hoy_MP = EDAD_CARTERA_HOY,
                                Valor_Vencido_MP = VALOR_VENCIDO_HOY,
                                Valor_Cuota_Mes_MP = VALOR_CUOTA_MES_HOY)

## CEM ##

cr_mora0 <- cr_mora0 %>% left_join(CEM_hoy %>% select(ASO_IDENTIFICACION,EDAD_CARTERA_HOY,VALOR_VENCIDO_HOY,VALOR_CUOTA_MES_HOY), by = c("CEDULA ASOCIADO" = "ASO_IDENTIFICACION"))

cr_mora0 <- cr_mora0 %>% rename(Edad_Hoy_CEM = EDAD_CARTERA_HOY,
                                Valor_Vencido_CEM = VALOR_VENCIDO_HOY,
                                Valor_Cuota_Mes_CEM = VALOR_CUOTA_MES_HOY)




Analisis <- cr_mora0 %>% group_by(`EDAD CARTERA HOY`) %>% 
                                summarise(Qasociados = n(),
                                        Valor_Vencido = sum(`VALOR VENCIDO HOY`),
                                         pp = round(Qasociados / length(cr_mora0$`CEDULA ASOCIADO`), 2),
                                        Valor_Vencido_Coomeva = sum(Valor_Vencido_Coomeva),
                                        Vencido_MP = sum(Valor_Vencido_MP, na.rm = TRUE),
                                        Vencido_CEM = sum(Valor_Vencido_CEM, na.rm = TRUE))

write_xlsx(list("DB" = cr_mora0, "Resumen" = Analisis ),"C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Resultado.xlsx")