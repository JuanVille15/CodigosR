library(DBI)
library(odbc)
library(writexl)
library(glue)
library(magrittr)
library(dplyr)
library(readxl)
library(conflicted)
library(dbplyr)
library(lubridate)
library(janitor)
library(readr)
library(Microsoft365R)
library(blastula)
library(janitor)

conflict_prefer("filter", "dplyr")

Connecion_SQL <- dbConnect( 
  odbc(),
  Driver = "Oracle in instantclient_21_13",
  DBQ = "bdcdpora23.intracoomeva.com.co:1575/CDPORA23", 
  SVC = "GRC", 
  encoding = "ISO-8859-1", 
  UID = "jjvt9593", 
  PWD = "Vj1w#jT6s9")

Base_Cruce_Cem <- dbGetQuery(Connecion_SQL,glue_sql(
  "SELECT ASO_IDENTIFICACION,
MAX(CASE WHEN FACT_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE FACT_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES) VALOR_CUOTA_MES_HOY,
SUM(FAC.FACT_VALOR_VENCIDO) VALOR_VENCIDO_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES + FAC.FACT_VALOR_VENCIDO) TOTAL_FACTURADO
FROM GRC.STG_GCC_FACTURACION FAC
LEFT OUTER JOIN GRC.GCC_CONCEPTO CON
ON FAC.CON_CODIGO = CON.CON_CODIGO
LEFT OUTER JOIN GRC.GCC_AGRUPACION EMP
ON CON.AGR_CODIGO = EMP.AGR_CODIGO
WHERE emp.age_codigo = 2 
AND FAC.CON_CODIGO IN ('CEMR',
'01CEAB',
'01CEAD',
'01CEAG',
'01CEAM',
'01CEAP',
'01CEAS',
'01CEAT',
'01CEA9',
'01CEB',
'01CEB1',
'01CECA',
'01CECE',
'01CEC1',
'01CEEF',
'01CEE1',
'01CEE2',
'01CEFE',
'01CEFG',
'01CEFI',
'01CEFO',
'01CEGF',
'01CEIN',
'01CEM',
'01CEMA',
'01CEMB',
'01CEMC',
'01CEME',
'01CEMH',
'01CEMJ',
'01CEMO',
'01CEMS',
'01CEMX',
'01CEMZ',
'01CEM1',
'01CEM3',
'01CEM4',
'01CEM7',
'01CEM8',
'01CEOC',
'01CEPD',
'01CEPM',
'01CEPO',
'01CEPR',
'01CEPS',
'01CEP2',
'01CERP',
'01CETE',
'01CET9',
'01CEUS',
'01CEX0',
'01CEX1',
'01CEX3',
'01CE19',
'01CE2P',
'01CE23',
'01CPEM',
'01EVEM',
'04CEAB',
'04CEAD',
'04CEAG',
'04CEAM',
'04CEAP',
'04CEAS',
'04CEAT',
'04CEA9',
'04CEB',
'04CEB1',
'04CECA',
'04CECE',
'04CEC1',
'04CEEF',
'04CEE1',
'04CEE2',
'04CEFE',
'04CEFG',
'04CEFI',
'04CEFO',
'04CEGF',
'04CEIN',
'04CEM',
'04CEMA',
'04CEMB',
'04CEMC',
'04CEME',
'04CEMH',
'04CEMJ',
'04CEMO',
'04CEMS',
'04CEMX',
'04CEMZ',
'04CEM1',
'04CEM3',
'04CEM4',
'04CEM7',
'04CEM8',
'04CEOC',
'04CEPD',
'04CEPM',
'04CEPO',
'04CEPR',
'04CEPS',
'04CEP2',
'04CERP',
'04CETE',
'04CET9',
'04CEUS',
'04CEX0',
'04CEX1',
'04CEX3',
'04CE19',
'04CE2P',
'04CE23',
'04CPEM',
'04EVEM',
'07CEM',
'07CEMC',
'07CEMO',
'07CEMS',
'07CEMZ',
'07CEM1',
'07CEM3',
'07CEM4',
'07CEM7',
'07CEM8',
'08CEM',
'08CEMC',
'08CEMJ',
'08CEMO',
'08CEMS',
'08CEMZ',
'08CEM1',
'08CEM3',
'08CEM4',
'08CEM7',
'08CEM8',
'09CEAG',
'09CEAP',
'09CEAS',
'09CEAT',
'09CEFE',
'09CEFG',
'09CEFO',
'09CEGF',
'09CEM',
'09CEMC',
'09CEMH',
'09CEMO',
'09CEMZ',
'09CEM1',
'09CEM3',
'09CEM4',
'09CEM7',
'09CEM8',
'09CEPD',
'09CEPM',
'09CEPO',
'09CEPR',
'09CEPS',
'09CEP2',
'09CERP',
'09CEX3',
'09CE2P',
'01CEMQ',
'04CEMQ',
'01CE50',
'04CE50',
'01PACE',
'04PACE',
'01TACE',
'04TACE',
'01CUE3',
'04CUE3',
'01CUE6',
'04CUE6',
'01CUE9',
'04CUE9',
'01CU12',
'04CU12',
'01CU23',
'04CU23',
'01CU26',
'04CU26',
'01CU29',
'04CU29',
'01CU22',
'04CU22',
'01CTL3',
'04CTL3',
'01CTL6',
'04CTL6',
'01CTL9',
'04CTL9',
'01CT12',
'04CT12',
'01CT23',
'04CT23',
'01CT26',
'04CT26',
'01CT29',
'04CT29',
'01CT22',
'04CT22',
'01FULL',
'04FULL')
GROUP BY (FAC.ASO_IDENTIFICACION);"))

Base_Cruce_MP <- dbGetQuery(Connecion_SQL,glue_sql(
  "SELECT ASO_IDENTIFICACION,
MAX(CASE WHEN FACT_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE FACT_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES) VALOR_CUOTA_MES_HOY,
SUM(FAC.FACT_VALOR_VENCIDO) VALOR_VENCIDO_HOY,
SUM(FAC.FACT_VALOR_CUOTA_MES + FAC.FACT_VALOR_VENCIDO) TOTAL_FACTURADO
FROM GRC.STG_GCC_FACTURACION FAC
LEFT OUTER JOIN GRC.GCC_CONCEPTO CON
ON FAC.CON_CODIGO = CON.CON_CODIGO
LEFT OUTER JOIN GRC.GCC_AGRUPACION EMP
ON CON.AGR_CODIGO = EMP.AGR_CODIGO
WHERE emp.age_codigo = 2 
AND FAC.CON_CODIGO NOT IN ('CEMR',
'01CEAB',
'01CEAD',
'01CEAG',
'01CEAM',
'01CEAP',
'01CEAS',
'01CEAT',
'01CEA9',
'01CEB',
'01CEB1',
'01CECA',
'01CECE',
'01CEC1',
'01CEEF',
'01CEE1',
'01CEE2',
'01CEFE',
'01CEFG',
'01CEFI',
'01CEFO',
'01CEGF',
'01CEIN',
'01CEM',
'01CEMA',
'01CEMB',
'01CEMC',
'01CEME',
'01CEMH',
'01CEMJ',
'01CEMO',
'01CEMS',
'01CEMX',
'01CEMZ',
'01CEM1',
'01CEM3',
'01CEM4',
'01CEM7',
'01CEM8',
'01CEOC',
'01CEPD',
'01CEPM',
'01CEPO',
'01CEPR',
'01CEPS',
'01CEP2',
'01CERP',
'01CETE',
'01CET9',
'01CEUS',
'01CEX0',
'01CEX1',
'01CEX3',
'01CE19',
'01CE2P',
'01CE23',
'01CPEM',
'01EVEM',
'04CEAB',
'04CEAD',
'04CEAG',
'04CEAM',
'04CEAP',
'04CEAS',
'04CEAT',
'04CEA9',
'04CEB',
'04CEB1',
'04CECA',
'04CECE',
'04CEC1',
'04CEEF',
'04CEE1',
'04CEE2',
'04CEFE',
'04CEFG',
'04CEFI',
'04CEFO',
'04CEGF',
'04CEIN',
'04CEM',
'04CEMA',
'04CEMB',
'04CEMC',
'04CEME',
'04CEMH',
'04CEMJ',
'04CEMO',
'04CEMS',
'04CEMX',
'04CEMZ',
'04CEM1',
'04CEM3',
'04CEM4',
'04CEM7',
'04CEM8',
'04CEOC',
'04CEPD',
'04CEPM',
'04CEPO',
'04CEPR',
'04CEPS',
'04CEP2',
'04CERP',
'04CETE',
'04CET9',
'04CEUS',
'04CEX0',
'04CEX1',
'04CEX3',
'04CE19',
'04CE2P',
'04CE23',
'04CPEM',
'04EVEM',
'07CEM',
'07CEMC',
'07CEMO',
'07CEMS',
'07CEMZ',
'07CEM1',
'07CEM3',
'07CEM4',
'07CEM7',
'07CEM8',
'08CEM',
'08CEMC',
'08CEMJ',
'08CEMO',
'08CEMS',
'08CEMZ',
'08CEM1',
'08CEM3',
'08CEM4',
'08CEM7',
'08CEM8',
'09CEAG',
'09CEAP',
'09CEAS',
'09CEAT',
'09CEFE',
'09CEFG',
'09CEFO',
'09CEGF',
'09CEM',
'09CEMC',
'09CEMH',
'09CEMO',
'09CEMZ',
'09CEM1',
'09CEM3',
'09CEM4',
'09CEM7',
'09CEM8',
'09CEPD',
'09CEPM',
'09CEPO',
'09CEPR',
'09CEPS',
'09CEP2',
'09CERP',
'09CEX3',
'09CE2P',
'01CEMQ',
'04CEMQ',
'01CE50',
'04CE50',
'01PACE',
'04PACE',
'01TACE',
'04TACE',
'01CUE3',
'04CUE3',
'01CUE6',
'04CUE6',
'01CUE9',
'04CUE9',
'01CU12',
'04CU12',
'01CU23',
'04CU23',
'01CU26',
'04CU26',
'01CU29',
'04CU29',
'01CU22',
'04CU22',
'01CTL3',
'04CTL3',
'01CTL6',
'04CTL6',
'01CTL9',
'04CTL9',
'01CT12',
'04CT12',
'01CT23',
'04CT23',
'01CT26',
'04CT26',
'01CT29',
'04CT29',
'01CT22',
'04CT22',
'01FULL',
'04FULL')
GROUP BY (FAC.ASO_IDENTIFICACION);"))

BANCOOMEVA_U_INICIO <- read_excel("C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Carpetas/MP/Base Bancoomeva _ MP/Asociado_Asignados_Bancoomeva_Febrero.xlsx")

BANCOOMEVA_U_HOY <- read_excel("C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Carpetas/Corrección R-10/Reporte10_2025-02-11.xlsx")

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>% filter(SUBCAMPAÑA == "BANCOOMEVA_U")

## RODADOS ##

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  mutate(MARCA_RODADO = ifelse(!(`CEDULA ASOCIADO` %in% BANCOOMEVA_U_INICIO$`CEDULA ASOCIADO`), "RODADO_CORTE_10",BANCOOMEVA_U_INICIO$MARCA_RODADO))

         
## VALIDADICÓN CEM ## 

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  mutate(PRODUCTOS_CEM = ifelse(`CEDULA ASOCIADO` %in% Base_Cruce_Cem$ASO_IDENTIFICACION, "SI", "NO"))
         
## VALIDADICÓN MP ## 

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  mutate(PRODUCTOS_MP = ifelse(`CEDULA ASOCIADO` %in% Base_Cruce_MP$ASO_IDENTIFICACION, "SI", "NO"))

## VALORES VENCIDOS ## 

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  left_join(Base_Cruce_Cem %>% select(ASO_IDENTIFICACION,VALOR_VENCIDO_HOY), by = c("CEDULA ASOCIADO" = "ASO_IDENTIFICACION"))

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  rename(VALOR_VENCIDO_CEM = VALOR_VENCIDO_HOY)

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  left_join(Base_Cruce_MP %>% select(ASO_IDENTIFICACION,VALOR_VENCIDO_HOY), by = c("CEDULA ASOCIADO" = "ASO_IDENTIFICACION"))

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>%
  rename(VALOR_VENCIDO_MP = VALOR_VENCIDO_HOY)

Columnas <- c("CEDULA ASOCIADO","NOMBRE ASOCIADO","REGIONAL","EDAD CARTERA INICIAL","EDAD CARTERA HOY","MARCA_RODADO","PRODUCTOS_CEM","PRODUCTOS_MP","VALOR_VENCIDO_CEM","VALOR_VENCIDO_MP")

BANCOOMEVA_U_HOY <- BANCOOMEVA_U_HOY %>% select(all_of(Columnas))

write_xlsx(BANCOOMEVA_U_HOY,"C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Carpetas/MP/Base Bancoomeva _ MP/Asociado_Asignados_Bancoomeva_Febrero.xlsx")
