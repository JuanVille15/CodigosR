library(DBI)
library(odbc)
library(writexl)
library(glue)
library(magrittr)
library(dplyr)
library(readxl)
library(conflicted)
library(dbplyr)
library(lubridate)
library(janitor)
library(readr)
library(Microsoft365R)
library(blastula)
library(janitor)

conflict_prefer("filter", "dplyr")

Connecion_SQL <- dbConnect( 
  odbc(),
  Driver = "Oracle in instantclient_21_3",
  DBQ = "bdcdpora23.intracoomeva.com.co:1575/CDPORA23", 
  SVC = "GRC", 
  encoding = "ISO-8859-1", 
  UID = "jjvt9593", 
  PWD = "JJf4#rd67J")

## Importante cambiar el periodo de facturacion dependiendo del mes, la facturacion es anticipada(en las 2 consultas).

Base_Cruce_Cem <- dbGetQuery(Connecion_SQL,glue_sql(
  "SELECT HFR_PERIODO_FACT,
        FR.ASO_IDENTIFICACION,
        REG.REG_NOMBRE,
        ZON.ZON_NOMBRE,
        OFI.OFI_NOMBRE,
        --CON_CODIGO,
        MAX(CASE WHEN HFR_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE HFR_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA,
        MAX(CASE WHEN HFR_CUOTAS_ATRASADAS_INI >= 7 THEN 7 ELSE HFR_CUOTAS_ATRASADAS_INI END) EDAD_CARTERA_INI,
        sum(HFR_VALOR_CUOTA_MES_CALCULADO) HFR_VALOR_CUOTA_MES_CALCULADO,
        sum(HFR_VALOR_VENCIDO_CALCULADO) HFR_VALOR_VENCIDO_CALCULADO,
        sum(HFR_VALOR_CUOTA_MES_CALCULADO) + sum(HFR_VALOR_VENCIDO_CALCULADO) VALOR_TOTAL_FACTURADO,
        sum(HFR_VALOR_RECAUDO_CMES) HFR_VALOR_RECAUDO_CMES,
        sum(HFR_VALOR_RCDO_VENCIDO) HFR_VALOR_RCDO_VENCIDO,
        SUM(HFR_VALOR_RCDO_CMES_MUL) VALOR_RCDO_CMES_MUL,
        SUM(HFR_VALOR_RCDO_CMES_FIN) VALOR_RCDO_CMES_FIN,
        SUM(HFR_VALOR_RCDO_VENC_MULT) VALOR_RCDO_VENC_MUL,
        SUM(HFR_VALOR_RCDO_VENC_FIN) VALOR_RCDO_VENC_FIN,
        SUM(HFR_VALOR_RCDO_CMES_MUL) + SUM(HFR_VALOR_RCDO_CMES_FIN) +
        SUM(HFR_VALOR_RCDO_VENC_MULT) + SUM(HFR_VALOR_RCDO_VENC_FIN) VALOR_TOTAL_RECAUDO  
FROM GRC.GCC_HIST_FACT_RECAUDO FR
JOIN GRC.GCC_ASOCIADO ASO ON FR.ASO_IDENTIFICACION=ASO.ASO_IDENTIFICACION
JOIN GRC.GCC_OFICINA OFI ON ASO.OFI_CODIGO=OFI.OFI_CODIGO
JOIN GRC.GCC_ZONA ZON ON OFI.ZON_CODIGO=ZON.ZON_CODIGO
JOIN GRC.GCC_REGIONAL REG ON ZON.REG_CODIGO=REG.REG_CODIGO
JOIN GRC.GCC_CONCEPTO CO ON FR.CON_CODIGO=CO.CON_CODIGO
JOIN GRC.GCC_AGRUPACION AG ON AG.AGR_CODIGO=CO.AGR_CODIGO
WHERE fr.HFR_PERIODO_FACT = 202502
AND AG.AGE_CODIGO = 2
AND FR.CON_CODIGO IN ('CEMR',
'01CEAB',
'01CEAD',
'01CEAG',
'01CEAM',
'01CEAP',
'01CEAS',
'01CEAT',
'01CEA9',
'01CEB',
'01CEB1',
'01CECA',
'01CECE',
'01CEC1',
'01CEEF',
'01CEE1',
'01CEE2',
'01CEFE',
'01CEFG',
'01CEFI',
'01CEFO',
'01CEGF',
'01CEIN',
'01CEM',
'01CEMA',
'01CEMB',
'01CEMC',
'01CEME',
'01CEMH',
'01CEMJ',
'01CEMO',
'01CEMS',
'01CEMX',
'01CEMZ',
'01CEM1',
'01CEM3',
'01CEM4',
'01CEM7',
'01CEM8',
'01CEOC',
'01CEPD',
'01CEPM',
'01CEPO',
'01CEPR',
'01CEPS',
'01CEP2',
'01CERP',
'01CETE',
'01CET9',
'01CEUS',
'01CEX0',
'01CEX1',
'01CEX3',
'01CE19',
'01CE2P',
'01CE23',
'01CPEM',
'01EVEM',
'04CEAB',
'04CEAD',
'04CEAG',
'04CEAM',
'04CEAP',
'04CEAS',
'04CEAT',
'04CEA9',
'04CEB',
'04CEB1',
'04CECA',
'04CECE',
'04CEC1',
'04CEEF',
'04CEE1',
'04CEE2',
'04CEFE',
'04CEFG',
'04CEFI',
'04CEFO',
'04CEGF',
'04CEIN',
'04CEM',
'04CEMA',
'04CEMB',
'04CEMC',
'04CEME',
'04CEMH',
'04CEMJ',
'04CEMO',
'04CEMS',
'04CEMX',
'04CEMZ',
'04CEM1',
'04CEM3',
'04CEM4',
'04CEM7',
'04CEM8',
'04CEOC',
'04CEPD',
'04CEPM',
'04CEPO',
'04CEPR',
'04CEPS',
'04CEP2',
'04CERP',
'04CETE',
'04CET9',
'04CEUS',
'04CEX0',
'04CEX1',
'04CEX3',
'04CE19',
'04CE2P',
'04CE23',
'04CPEM',
'04EVEM',
'07CEM',
'07CEMC',
'07CEMO',
'07CEMS',
'07CEMZ',
'07CEM1',
'07CEM3',
'07CEM4',
'07CEM7',
'07CEM8',
'08CEM',
'08CEMC',
'08CEMJ',
'08CEMO',
'08CEMS',
'08CEMZ',
'08CEM1',
'08CEM3',
'08CEM4',
'08CEM7',
'08CEM8',
'09CEAG',
'09CEAP',
'09CEAS',
'09CEAT',
'09CEFE',
'09CEFG',
'09CEFO',
'09CEGF',
'09CEM',
'09CEMC',
'09CEMH',
'09CEMO',
'09CEMZ',
'09CEM1',
'09CEM3',
'09CEM4',
'09CEM7',
'09CEM8',
'09CEPD',
'09CEPM',
'09CEPO',
'09CEPR',
'09CEPS',
'09CEP2',
'09CERP',
'09CEX3',
'09CE2P',
'01CEMQ',
'04CEMQ',
'01CE50',
'04CE50',
'01PACE',
'04PACE',
'01TACE',
'04TACE',
'01CUE3',
'04CUE3',
'01CUE6',
'04CUE6',
'01CUE9',
'04CUE9',
'01CU12',
'04CU12',
'01CU23',
'04CU23',
'01CU26',
'04CU26',
'01CU29',
'04CU29',
'01CU22',
'04CU22',
'01CTL3',
'04CTL3',
'01CTL6',
'04CTL6',
'01CTL9',
'04CTL9',
'01CT12',
'04CT12',
'01CT23',
'04CT23',
'01CT26',
'04CT26',
'01CT29',
'04CT29',
'01CT22',
'04CT22',
'10FULL',
'04FULL') 
GROUP BY HFR_PERIODO_FACT, FR.ASO_IDENTIFICACION, REG.REG_NOMBRE, ZON.ZON_NOMBRE, OFI.OFI_NOMBRE
;"))


Base_Cruce_MP <- dbGetQuery(Connecion_SQL,glue_sql(
  "SELECT HFR_PERIODO_FACT,
        FR.ASO_IDENTIFICACION,
        REG.REG_NOMBRE,
        ZON.ZON_NOMBRE,
        OFI.OFI_NOMBRE,
--        CON_CODIGO,
        MAX(CASE WHEN HFR_NUMERO_CUOTAS_ATRASADAS >= 7 THEN 7 ELSE HFR_NUMERO_CUOTAS_ATRASADAS END) EDAD_CARTERA,
        MAX(CASE WHEN HFR_CUOTAS_ATRASADAS_INI >= 7 THEN 7 ELSE HFR_CUOTAS_ATRASADAS_INI END) EDAD_CARTERA_INI,
        sum(HFR_VALOR_CUOTA_MES_CALCULADO) HFR_VALOR_CUOTA_MES_CALCULADO,
        sum(HFR_VALOR_VENCIDO_CALCULADO) HFR_VALOR_VENCIDO_CALCULADO,
        sum(HFR_VALOR_CUOTA_MES_CALCULADO) + sum(HFR_VALOR_VENCIDO_CALCULADO) VALOR_TOTAL_FACTURADO,
        sum(HFR_VALOR_RECAUDO_CMES) HFR_VALOR_RECAUDO_CMES,
        sum(HFR_VALOR_RCDO_VENCIDO) HFR_VALOR_RCDO_VENCIDO,
        SUM(HFR_VALOR_RCDO_CMES_MUL) VALOR_RCDO_CMES_MUL,
        SUM(HFR_VALOR_RCDO_CMES_FIN) VALOR_RCDO_CMES_FIN,
        SUM(HFR_VALOR_RCDO_VENC_MULT) VALOR_RCDO_VENC_MUL,
        SUM(HFR_VALOR_RCDO_VENC_FIN) VALOR_RCDO_VENC_FIN,
        SUM(HFR_VALOR_RCDO_CMES_MUL) + SUM(HFR_VALOR_RCDO_CMES_FIN) +
        SUM(HFR_VALOR_RCDO_VENC_MULT) + SUM(HFR_VALOR_RCDO_VENC_FIN) VALOR_TOTAL_RECAUDO  
FROM GRC.GCC_HIST_FACT_RECAUDO FR
JOIN GRC.GCC_ASOCIADO ASO ON FR.ASO_IDENTIFICACION=ASO.ASO_IDENTIFICACION
JOIN GRC.GCC_OFICINA OFI ON ASO.OFI_CODIGO=OFI.OFI_CODIGO
JOIN GRC.GCC_ZONA ZON ON OFI.ZON_CODIGO=ZON.ZON_CODIGO
JOIN GRC.GCC_REGIONAL REG ON ZON.REG_CODIGO=REG.REG_CODIGO
JOIN GRC.GCC_CONCEPTO CO ON FR.CON_CODIGO=CO.CON_CODIGO
JOIN GRC.GCC_AGRUPACION AG ON AG.AGR_CODIGO=CO.AGR_CODIGO
WHERE fr.HFR_PERIODO_FACT = 202502
AND AG.AGE_CODIGO= 2
AND FR.CON_CODIGO NOT IN ('CEMR',
'01CEAB',
'01CEAD',
'01CEAG',
'01CEAM',
'01CEAP',
'01CEAS',
'01CEAT',
'01CEA9',
'01CEB',
'01CEB1',
'01CECA',
'01CECE',
'01CEC1',
'01CEEF',
'01CEE1',
'01CEE2',
'01CEFE',
'01CEFG',
'01CEFI',
'01CEFO',
'01CEGF',
'01CEIN',
'01CEM',
'01CEMA',
'01CEMB',
'01CEMC',
'01CEME',
'01CEMH',
'01CEMJ',
'01CEMO',
'01CEMS',
'01CEMX',
'01CEMZ',
'01CEM1',
'01CEM3',
'01CEM4',
'01CEM7',
'01CEM8',
'01CEOC',
'01CEPD',
'01CEPM',
'01CEPO',
'01CEPR',
'01CEPS',
'01CEP2',
'01CERP',
'01CETE',
'01CET9',
'01CEUS',
'01CEX0',
'01CEX1',
'01CEX3',
'01CE19',
'01CE2P',
'01CE23',
'01CPEM',
'01EVEM',
'04CEAB',
'04CEAD',
'04CEAG',
'04CEAM',
'04CEAP',
'04CEAS',
'04CEAT',
'04CEA9',
'04CEB',
'04CEB1',
'04CECA',
'04CECE',
'04CEC1',
'04CEEF',
'04CEE1',
'04CEE2',
'04CEFE',
'04CEFG',
'04CEFI',
'04CEFO',
'04CEGF',
'04CEIN',
'04CEM',
'04CEMA',
'04CEMB',
'04CEMC',
'04CEME',
'04CEMH',
'04CEMJ',
'04CEMO',
'04CEMS',
'04CEMX',
'04CEMZ',
'04CEM1',
'04CEM3',
'04CEM4',
'04CEM7',
'04CEM8',
'04CEOC',
'04CEPD',
'04CEPM',
'04CEPO',
'04CEPR',
'04CEPS',
'04CEP2',
'04CERP',
'04CETE',
'04CET9',
'04CEUS',
'04CEX0',
'04CEX1',
'04CEX3',
'04CE19',
'04CE2P',
'04CE23',
'04CPEM',
'04EVEM',
'07CEM',
'07CEMC',
'07CEMO',
'07CEMS',
'07CEMZ',
'07CEM1',
'07CEM3',
'07CEM4',
'07CEM7',
'07CEM8',
'08CEM',
'08CEMC',
'08CEMJ',
'08CEMO',
'08CEMS',
'08CEMZ',
'08CEM1',
'08CEM3',
'08CEM4',
'08CEM7',
'08CEM8',
'09CEAG',
'09CEAP',
'09CEAS',
'09CEAT',
'09CEFE',
'09CEFG',
'09CEFO',
'09CEGF',
'09CEM',
'09CEMC',
'09CEMH',
'09CEMO',
'09CEMZ',
'09CEM1',
'09CEM3',
'09CEM4',
'09CEM7',
'09CEM8',
'09CEPD',
'09CEPM',
'09CEPO',
'09CEPR',
'09CEPS',
'09CEP2',
'09CERP',
'09CEX3',
'09CE2P',
'01CEMQ',
'04CEMQ',
'01CE50',
'04CE50',
'01PACE',
'04PACE',
'01TACE',
'04TACE',
'01CUE3',
'04CUE3',
'01CUE6',
'04CUE6',
'01CUE9',
'04CUE9',
'01CU12',
'04CU12',
'01CU23',
'04CU23',
'01CU26',
'04CU26',
'01CU29',
'04CU29',
'01CU22',
'04CU22',
'01CTL3',
'04CTL3',
'01CTL6',
'04CTL6',
'01CTL9',
'04CTL9',
'01CT12',
'04CT12',
'01CT23',
'04CT23',
'01CT26',
'04CT26',
'01CT29',
'04CT29',
'01CT22',
'04CT22',
'01FULL',
'04FULL')
GROUP BY HFR_PERIODO_FACT, FR.ASO_IDENTIFICACION, REG.REG_NOMBRE, ZON.ZON_NOMBRE, OFI.OFI_NOMBRE
;"))


dbDisconnect(Connecion_SQL)

Gestiones_Enero <- read.csv("C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Carpetas/WSAC/Gestiones/Enero/Gestiones_Enero_Con_Bancoomeva.csv")
Gestiones_Enero <- transform(
  Gestiones_Enero,identificacion_deudor = as.numeric(identificacion_deudor))

Base_Cruce_MP <- transform(
  Base_Cruce_MP,ASO_IDENTIFICACION = as.numeric(ASO_IDENTIFICACION))

Gestiones_MP_Cobro <- Gestiones_Enero %>%
  semi_join(Base_Cruce_MP, by= c("identificacion_deudor"="ASO_IDENTIFICACION"))

Gestiones_CEM_Cobro <- Gestiones_Enero %>%
  semi_join(Base_Cruce_Cem, by= c("identificacion_deudor"="ASO_IDENTIFICACION"))


Gestiones_MP_Cobro %>%
  write_xlsx(
    glue(
      "C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Carpetas/MP/Facturacion/Resultado/Gestiones_CobroMP_Enero_Con.xlsx",col_names=TRUE))

Gestiones_CEM_Cobro %>%
  write_xlsx(
    glue(
      "C:/Users/jjvt9593/OneDrive - Grupo Coomeva/Escritorio/Carpetas/MP/Facturacion/Resultado/Gestiones_CobroCEM_Enero_Con.xlsx",col_names=TRUE))
